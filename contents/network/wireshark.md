# Wireshark

## 何をするもの？
Wiresharkは、ネットワークを流れるデータを取得、解析してその内容を表示するソフトウェアです。

ネットワークで送受信されるデータには、本来送りたいデータ（テキスト、音声、動画等）に加え、宛先や誤り訂正のための符号等を含む、
多種多様な制御情報が付加されています。
Wiresharkはその制御情報を解析し、見やすいように表示する機能を持っています。
ネットワーク管理にはもとより、サーバ運用やトラブルシューティングにも不可欠の道具です。
Linux, MacOS, 各種Unixの他Windowsでも動作します。なお、Windowsでは同様のことを行うMicrosoft Message Analyzerというソフトウェアもあります。

なお、ネットワークを流れるデータを取り込むことを「キャプチャcaptureする」と言います。

## 注意
東京大学情報セキュリティポリシー実施手順（一般操作機器・端末編）には、「自端末宛以外のパケットを傍受するアプリケーション（パケットスニファ等）を利用してはならない」等の規定があります。

Wiresharkはここで言う「自端末宛以外のパケットを傍受するアプリケーション」に該当します。

204号室に設置されている実習用PCは実験・実習用機器で、一般操作端末ではないと解されるし、教育・研究目的で対象とするネットワークの管理者が許可したものでもあるので、その上でWiresharkを動かすのは問題ありません。
しかし、自分のノートPCをUTokyo-Wifiなどの学内ネットワークに接続してWiresharkを動作させるのは上記規定に抵触しますので行わないでください。

## インストールと起動
Wiresharkをインストールして使えるようにします。

### Ubuntu
Microsoftストアアプリとして導入したUbuntu上ではWiresharkは使えません。
Windows版Wiresharkを使ってください。

ネイティブまたは仮想マシン上のUbuntuでは以下のようにしてインストールできます。
```
$ sudo apt install wireshark-qt
```
で必要なファイルをインストールする。
ダイアログが出たらYesを選択。

インストールが終わったら、自分をwiresharkグループに追加する。
（`username`は自分のログイン名に置き換える）
```
$ sudo gpasswd -a username wireshark
$ newgrp wireshark
```

なお、開発・配布元のWebページ http://www.wireshark.org/ も見ておくこと。

#### 起動
Unix/LinuxではWiresharkを起動するのにroot特権が必要だが、
上のようにインストールするとsudoせずに起動できる。
```
$ wireshark
```
wiresharkが起動し、ウィンドウが一つ開く。
以後、このウィンドウ内で操作する。

### Windows
開発・配布元のWebページ http://www.wireshark.org/ からインストーラをダウンロードし、実行する。

## キャプチャ開始
1. 画面中央にインターフェイスのリストが出るので、一番上のenp0??を選ぶ。
1. 画面左上の青い三角（サメのヒレ？）のアイコンをクリックするとキャプチャが始まる。
1. そのPC上で他に何もしていないとパケットが表示されないかもしれない。その場合はブラウザを起動してみるとよい。
1. キャプチャを止めるときには、画面左上から二つ目の赤い四角のアイコンをクリックする。
1. 表示パネルは上下３つに分かれている。
1. 一番上のパネルにどんどん表示されていく一行一行がデータの固まり（フレーム）に対応している。
1. 適当な行を選び、クリックすると、２段目に概要が、一番下のパネルにフレームの内容の詳細が表示される。
1. 一番下のパネルの中では、左側に１バイト毎のデータを16進数で表したものが並び、その中でASCIIコード（英数字記号等）と解釈できるものについて右側に対応する表示が出ている。
1. 最近のWebトラフィックはほとんど暗号化されているので読み取れるものは少ないが、よく見ると中には読める文字列が並んでいるものもあるかもしれない。
1. 実習用PCはすべて204号室内実習用ネットワークに接続されていて、
このネットワークは実習専用でよけいなものがつながっておらず「静か」なのが普通。
もし変なものが見えたらTAに知らせてください。

## Web
1. キャプチャを行いながら、Webブラウザを起動し、適当なページを表示する。どのようなデータが表示されるか？
1. http;//で始まるURLのサイトを開くと、データの中を見ることができる。
1. 適当なフレームを選び、内容の詳細を表示させてみると、HTTPプロトコル、HTMLのデータが流れていることが確認できる。

## Packet Filter
単純にキャプチャしたのではデータが多すぎる場合、 設定した条件に合うフレームのみをキャプチャする機能がある。

左から４つ目のアイコン（◯の中に歯車）をクリックし、Capture Optionsを設定することで絞り込むことができる。

## 保存
キャプチャしたデータはファイルに保存しておくことができる。

不正アクセスに対処するとき、ネットワークの挙動がおかしいとき、様々な場合に保存したキャプチャデータが活用される。

逆に、保存が不要な場合は、Startを選択した際やWiresharkを終了する際に現れるダイアログで
「保存せずに終了」を選べばよい。
